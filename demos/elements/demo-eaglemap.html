<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">


<link rel="import" href="../../elements/gm-mappu-map.html">
<link rel="import" href="../../elements/gm-mappu-layermanager.html">
<link rel="import" href="../../elements/gm-mappu-zoombuttons.html">
<link rel="import" href="../../elements/gm-mappu-geosearch.html">
<link rel="import" href="../../elements/gm-mappu-catalog.html">
<link rel="import" href="../../elements/gm-mappu-stylesets.html">
<link rel="import" href="../../elements/gm-mappu-sketch.html">

<link rel="import" href="../../elements/gm-cow-core.html">
<link rel="import" href="../../elements/gm-cow-projectlist.html">
<link rel="import" href="../../elements/gm-cow-userlist.html">
<link rel="import" href="../../elements/gm-docs-configui.html">
<link rel="import" href="../../elements/gm-geosearch.html">
<link rel="import" href="../../elements/gm-icm-natuurbrand.html">
<link rel="import" href="../../elements/gm-plugins-rws.html">
<link rel="import" href="../../elements/gm-plugins-tracker.html">

<dom-module id="demo-eaglemap">
<style>
 #drawer {
 	 opacity: 0.9;
 }
</style>
<template>
	<paper-header-panel>
	<paper-toolbar>
		<iron-selector attr-for-selected="name" selected="{{selected}}">
		  <paper-icon-button name="sketchbox" toggles icon="icons:create"></paper-icon-button>
		  <paper-icon-button name="layerbox" toggles icon="maps:layers"></paper-icon-button>
		  <paper-icon-button name="" toggles icon="maps:my-location"></paper-icon-button>
		  <paper-icon-button name="geosearchbox" toggles icon="icons:search"></paper-icon-button>
		  <paper-icon-button name="natuurbrandbox" toggles icon="social:whatshot"></paper-icon-button>
		  <paper-icon-button name="" toggles icon="icons:fullscreen" on-click='enterFullscreen'></paper-icon-button>
		  <paper-icon-button name="gmconfigbox" toggles icon="icons:cloud"></paper-icon-button>
		  <paper-icon-button name="trackerbox" toggles icon="icons:trending-up"></paper-icon-button>
		  <paper-icon-button name="rwsbox" toggles icon="icons:trending-up"></paper-icon-button>
		  
		  <paper-icon-button name="textbox" toggles icon="editor:format-size"></paper-icon-button>
		</iron-selector>
	</paper-toolbar>
	<div class='content'>
		
		<paper-drawer-panel id="drawer" right-drawer disable-swipe drawer-width="300">
			<div drawer>
			<iron-pages attr-for-selected="id" selected="{{selected}}">
				<div id='natuurbrandbox'>
					<gm-icm-natuurbrand map="{{map}}"></gm-icm-natuurbrand>
				</div>
				<div id='geosearchbox'>
					<gm-geosearch></gm-geosearch>
				</div>
				<div id='gmconfigbox'>
					<gm-docs-configui id='gmconfig' name='configs'
						configs="{{configs}}"
						account="{{account}}"
						></gm-docs-configui>
				</div>
			
				<div id='layerbox'>
					<gm-mappu-layermanager id="layermanager" map="{{map}}"></gm-mappu-layermanager>
				</div>
				
				<div id='rwsbox'>
					<gm-plugins-rws id="rwsplugin" map="{{map}}"></gm-plugins-rws>
				</div>
				
				<div id='trackerbox'>
					<gm-plugins-tracker id="tracker" map="{{map}}"></gm-plugins-tracker>
				</div>
				
				<div id='textbox'>
					<gm-icm-text id="eagletext" 
						data="{{textdata}}" 
						items="{{textitems}}" 
						store="{{store}}" 
						activeuser="{{activeuser}}"
						on-goto-location="gotolocation">
					</gm-icm-text>
				</div>
				
				<div id='sketchbox'>
					<gm-mappu-sketch id="sketch" layer="{{cowlayer}}" styleset="{{styleset}}"></gm-mappu-sketch>
					<gm-mappu-stylesets styleset1="{{styleset}}"></gm-mappu-stylesets>
				</div>
			</iron-pages>
			</div>
			<div main>
				<gm-mappu-map class='fit' id='mapelement' map="[[map]]">
					<gm-mappu-zoombuttons id="zoombuttons" map="{{map}}"></gm-mappu-zoombuttons>
				</gm-mappu-map>
			</div>
		</paper-drawer-panel>
	</div>

	</paper-header-panel>
</template>
</dom-module>

<script>
Polymer({
    is: 'demo-eaglemap',
    properties: {
    	map: Object,
    	selected: {
    		observer: '_selectedChanged' 
    	},
    	features: {
    		type: Array,
    		//value: function(){return [];},
    		observer: '_reload'
    	},
    	startlocation: {
    		observer: 'activate'
    	}
    },
    observers: [
    	
    ],
    ready: function(){
    	var self = this;
    	this.$.drawer.closeDrawer();
    	this.map = this.$.mapelement.map;
    	new d3.mappu.RasterLayer('Topografie',  {
            ogc_type: 'tms',
            url: 'https://{s}.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IlhHVkZmaW8ifQ.hAMX5hSW-QnTeRCMAy9A8Q',
            //url: 'http://{s}.tiles.mapbox.com/v3/examples.map-i86nkdio/{z}/{x}/{y}.png',
            visible: true
		 })
		 .addTo(this.map);
		 /*
		 new d3.mappu.RasterLayer('GRB-basiskaart (Vlaanderen)',  {
            ogc_type: 'wms',
            url: 'http://geoservices.informatievlaanderen.be/raadpleegdiensten/GRB-basiskaart/wms?',
            layers: ['GRB_BSK'],
            visible: true
		 })
		 .addTo(this.map);
		  
		 new d3.mappu.RasterLayer('Watertoets - Hellingenkaart',  {
            ogc_type: 'wms',
            url: 'http://geo.agiv.be/ogc/wms/product/VMMWatertoets?',
            layers: ['Helling'],
            visible: true,
            opacity: 0
		 })
		 .addTo(this.map);
		 new d3.mappu.RasterLayer('Watertoets - Overstromingsgevoelige gebieden 2014',  {
            ogc_type: 'wms',
            url: 'http://geo.agiv.be/ogc/wms/product/VMMWatertoets?',
            layers: ['Ovstrgev2014'],
            visible: true,
            opacity: 0
		 })
		 .addTo(this.map);
		*/
		 
		 
		 this.cowlayer = new d3.mappu.VectorLayer('cow',{
    		reproject: true,
    		style: {
    			'fill-opacity': 0.5
    		},
			labelfield: 'label'
		 })
		 .addTo(this.map);
		 //TODO: Would like to automise this
		 this.$.layermanager.layers = this.map.layers;
		 
		 this.$.sketch.addEventListener('featureRemoved', function(d){
			 var feature = d.detail;
			 self.store.records(feature.id.toString()).deleted(true).sync();
		 });
		 this.map.mapdiv.addEventListener('featureChanged', function(d){
		 	var feature = d.detail;
		 	self.store.records(feature.id.toString()).data('feature',feature).sync();
		 });
		 this.$.sketch.addEventListener('featureChanged', function(d){
		 	var feature = d.detail;
		 	//self.store.records(feature.id.toString()).data('feature',feature).sync();
		 });
		 this.$.sketch.addEventListener('featureCreated', function(d){
		 	var feature = d.detail;
		 	//Make feature ready for EagleWater
		 	for (var attrname in feature.style) { feature.properties[attrname] = feature.style[attrname]; }
		 	self.store.records({_id:feature.id.toString()}).data('type','feature').data('feature',feature).sync();
		 });
		 this.addEventListener('configselected', function(c){
    		var layers = c.detail.layers;
    		layers.filter(function(l){
    			return l.source.type.toLowerCase() == 'ogc_wms';
    		}).forEach(function(l){
    			new d3.mappu.RasterLayer(l.title,  {
					ogc_type: 'wms',
					url: l.source.url,
					layers: [l.source.featureName],
					visible: true || l.options.visible
				 })
				 .addTo(self.map);
    		});
    		//TODO: Would like to automise this
    		self.$.layermanager.layers = self.map.layers;
    	});
    	 this.addEventListener('goto-coords',function(c){
    	 	self.map.center = c.detail;
    	 });
    },
    activate: function(){
    	if (this.startlocation){//TODO
			var center = this.startlocation;
			this.map.center = [center.lng,center.lat];
			this.map.zoom = center.zoom;
			var self = this;
			window.setTimeout(function(){
				self.map.resize();
			});
			this._reload();
		}
	},
	_reload: function(){
		if (this.features){//TODO
			this.cowlayer.data = this.features.map(function(d){
				//copy stype from properties to be in line with EagleWater
				var feat = d.data('feature');
				feat.id = d.id();
				feat.style = feat.properties;
				return feat;
			});
		}
	},
	_selectedChanged: function(){
		this.$.drawer.openDrawer();
	},
	enterFullscreen: function () {
		var self = this;
		this.$.mapelement.webkitRequestFullscreen();
		//TODO: this should be a promise or something...
		window.setTimeout(function(){
			self.map.resize();
		},1000);
		
    }
});
</script>
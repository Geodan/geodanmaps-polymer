<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">

<link rel="import" href="../../elements/gm-cas-icon.html">
<link rel="import" href="../../elements/gm-docs-text.html">
<link rel="import" href="../../elements/gm-icm-text.html">

<link rel="import" href="../../elements/gm-mappu-map.html">

<link rel="import" href="../../elements/gm-cow-core.html">
<link rel="import" href="../../elements/gm-cow-projectlist.html">
<link rel="import" href="../../elements/gm-cow-userlist.html">


<dom-module id="demo-eagletext">
<style>
	paper-scroll-header-panel {
	  height: 100%;
	  background: white;
	}
	 .menu {
		cursor: pointer;
		background: white;
	}
	
	.accounting {
		background: #3f51b5;
		color: white;
	}
	
</style>
<template>
	<gm-cow-core id="cowcore" config="{{cowconfig}}" core="{{core}}"></gm-cow-core>
	<paper-drawer-panel id='drawerpanel'>
	 <paper-header-panel mode="seamed" drawer>
	 	<paper-toolbar>
	 		<img src='../images/icon-eagle.png'/>
	 	</paper-toolbar>
	 	<div class='accounting'>
			<gm-cas-icon  account="{{account}}"></gm-cas-icon>
		</div>
    	<iron-selector attr-for-selected="name" selected="{{selected}}">
    		<template is="dom-if" if="[[account.ID]]">
				<paper-item class='menu' name='users'>Users</paper-item>
				<paper-item class='menu' name='projects'>Incidents</paper-item>
				<template is="dom-if" if="[[curproject]]">
					<paper-item class='menu' name='text'>Text</paper-item>
					<paper-item class='menu' name='map'>Map</paper-item>
					<paper-item class='menu' name='chat'>Chat</paper-item>
				</template>
			</template>
    	</iron-selector>
    </paper-header-panel>
    <paper-scroll-header-panel main class="flex">
    	<paper-toolbar>
    		<paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
    		<div class='title'>{{curproject._data.name}}</div>
    	</paper-toolbar>
		<iron-pages class='pages' attr-for-selected="name" selected="{{selected}}">
			<div name='nouser'>U bent niet ingelogd</div>
			<gm-cow-userlist name='users' core="{{core}}"></gm-cow-userlist>
			<gm-cow-projectlist name='projects' core="{{core}}" 
				project="{{curproject}}"></gm-cow-projectlist>
			<div name="text">
				<gm-docs-text account="{{account}}" projectid="{{curproject._id}}" data="{{textdata}}"></gm-docs-text>
				<gm-icm-text data="{{textdata}}" core="{{core}}" project="{{curproject}}"></gm-icm-text>
			</div>
			<div name="map">
				<gm-mappu-map id='mapelement'></gm-mappu-map>
			</div>
			<div name="chat">
				Chat will be here...
			</div>
		</iron-pages>
    </paper-scroll-header-panel>
</paper-drawer-panel>
</template>
</dom-module>

<script>
Polymer({
    is: 'demo-eagletext',
    properties: {
    	cowconfig: {
    		value: {
    			protocol: 'wss',
    			url: 'sslgw.geodan.nl/eaglewater/',
    			port: 8081,
    			dir: 'geofort',
    			key: 'geofort'
    		}
    	},
    	account: {
    		type: Object
    	},
    	curproject: {
    		type: Object,
    		observer: '_projectChanged'
    	},
    	selected: {
    		value: function(){
    			return this.account?'projects':'nouser';
    		},
    		observer: '_selectedChanged'
    	}
    },
    observers: [
    	'accountChanged(account.ID)'
    ],
    ready: function(){
    	this.map = this.$.mapelement.map;
    	var testlayer = new d3.mappu.RasterLayer('Mapbox baselayer',  {
            ogc_type: 'tms',
            url: 'https://{s}.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IlhHVkZmaW8ifQ.hAMX5hSW-QnTeRCMAy9A8Q',
            //url: 'http://{s}.tiles.mapbox.com/v3/examples.map-i86nkdio/{z}/{x}/{y}.png',
            visible: true
		 })
		 .addTo(this.map);
		 this.cowlayer = new d3.mappu.VectorLayer('cow',{
    		reproject: true,
    		style: {
    			'fill-opacity': 0.5
    		},
			labelfield: 'label'
		 })
		 .addTo(this.map);
    },
    accountChanged: function(){
    	var self = this;
    	this.core.userStore().loaded.then(function(){
    		if (self.account.ID){
    			var user = self.core.user(self.account.ID);
    			if (!user)
    			{
					//if user is not know to cow yet, create it
					self.core.users({_id:self.account.ID})
						.data('name',self.account.FirstName + ' ' + self.account.LastName);
						self.core.user(self.account.ID);
				}
				self.selected = 'projects';
    		}
    		else {
    			self.selected = 'nouser';
    		}
    	});
    },
    _projectChanged: function(){
    	this.selected = 'text';
    },
    _selectedChanged: function(s){
    	this.$.drawerpanel.closeDrawer();
    	if (s=='map'){
    		var center = this.curproject.data('incidentLocation');
    		this.map.center = [center.lng,center.lat];
    		this.map.zoom = center.zoom;
    		this.map.resize();
    		var data = this.curproject.items().filter(function(d){
    				return !d.deleted() && d.data('type') == 'feature';
    		}).map(function(d){
    			var feat = d.data('feature');
    			feat.style = feat.properties;
    			return feat;
    		});
    		this.cowlayer.data = data; 
    	}
    }
});
</script>